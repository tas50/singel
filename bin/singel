#!/usr/bin/env ruby
# encoding: UTF-8
#
# Author:: Tim Smith (<tim@cozy.co>)
# Copyright:: Copyright (c) 2014 Tim Smith
# License:: Apache License, Version 2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))

begin
  require 'optparse'
  require 'English'
  require 'aws-sdk-core'
  require 'json'
  require 'pty'
  require 'orchestrator.rb'
  require 'executor.rb'
  require 'uploader.rb'
  require 'template.rb'
rescue LoadError => e
  raise "Missing gem or lib #{e}"
end

# add a few methods for manipulating text
class String
  def to_green
    "\033[32m#{self}\033[0m"
  end

  def to_red
    "\033[31m#{self}\033[0m"
  end

  def indent(double_space_count = 1)
    double_space_count.times { insert(0, '  ') }
    self
  end
end

def parse_opts
  options = { :templates => [], :builders => [], :packer_dir => File.expand_path('./packer') }
  banner = "Singel - Unified system image creation using Packer\n\n" \
            "Usage: singel [action] [options]\n\n" \
            "  Actions:\n" \
            "    build: Build system images\n" \
            "    list: List available image templates and builder types (AMI, Virtualbox, etc)\n\n" \
            "  Options:\n"
  OptionParser.new do |opts|
    opts.banner = banner
    opts.on('-t', '--templates t1.json,t2.json', Array, 'Build only the specified comma separated list of templates') do |t|
      options[:templates] = t
    end
    opts.on('-b', '--builders type1,type2', Array, 'Build only the specified comma separated list of builder types') do |b|
      options[:builders] = b
    end
    opts.on('-p', '--packer_dir PATH', 'Path to the packer dir containing templates and other files') do |p|
      options[:packer_dir] = File.expand_path(p)
    end
    opts.on('-h', '--help', 'Displays Help') do
      puts opts
      exit
    end
  end.parse!(ARGV)

  options
end

unless ARGV[0]
  puts "You must provide an action for singel to execute on\n".to_red
  ARGV << '-h'
end

# parse the user provided options
options = parse_opts

Singel::SingelOrchestrator.new(options).run
